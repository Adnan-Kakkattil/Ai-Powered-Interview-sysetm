{% extends 'base.html' %}

{% block title %}Interview Room - AI Interview System{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">

<div class="main-container">
    <!-- Left Panel: Code Editor -->
    <div class="editor-panel">
        <div class="panel-header">
            <span>Python Editor</span>
            <span class="status-badge">Live Sync Active</span>
        </div>
        <textarea id="codeEditor"># Write your code here...</textarea>
    </div>

    <!-- Right Panel: Video Call -->
    <div class="video-panel">
        <div class="meet-container">
            <div class="video-grid">
                <!-- Remote Video (Main) -->
                <div class="remote-video-wrapper">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="participant-label">
                        {% if role == 'interviewer' %}
                        Candidate: {{ interview.candidate_name }}
                        {% else %}
                        Interviewer: {{ interview.interviewer_name }}
                        {% endif %}
                    </div>
                </div>

                <!-- Local Video (PIP) -->
                <div class="local-video-wrapper">
                    <video id="localVideo" autoplay playsinline muted></video>
                    <div class="participant-label">You ({{ role|title }})</div>
                </div>
            </div>

            <!-- Control Bar -->
            <div class="control-bar">
                <div class="control-group">
                    <button id="toggleMic" class="control-btn" title="Toggle Microphone"><span
                            class="material-icons">mic</span></button>
                    <button id="toggleCam" class="control-btn" title="Toggle Camera"><span
                            class="material-icons">videocam</span></button>
                    <button id="toggleChat" class="control-btn" title="Chat"><span
                            class="material-icons">chat</span></button>
                    <button id="shareScreen" class="control-btn" title="Share Screen"><span
                            class="material-icons">present_to_all</span></button>

                    {% if role == 'interviewer' %}
                    <button class="control-btn btn-end-call" title="End Interview" onclick="confirmEndCall()">
                        <span class="material-icons">call_end</span>
                    </button>
                    {% else %}
                    <a href="{{ url_for('main.dashboard') }}" class="control-btn btn-end-call" title="Leave Call">
                        <span class="material-icons">call_end</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Sidebar -->
    <div id="chatSidebar" class="chat-sidebar">
        <div class="chat-header">
            <span>Chat</span>
            <button id="closeChat" class="icon-btn"><span class="material-icons">close</span></button>
        </div>
        <div id="chatMessages" class="chat-messages">
            {% for msg in chat_history %}
            <div class="chat-message {% if msg.sender_username == session.name %}self{% else %}remote{% endif %}">
                <div class="message-meta">
                    <span class="message-user">{% if msg.sender_username == session.name %}You{% else %}{{
                        msg.sender_username }}{% endif %}</span>
                    <span class="message-time">{{ msg.timestamp }}</span>
                </div>
                <div class="message-content">{{ msg.message }}</div>
            </div>
            {% endfor %}
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Send a message...">
            <button id="sendChat" class="icon-btn send-btn"><span class="material-icons">send</span></button>
        </div>
    </div>

    <div id="toast-container"></div>
</div>

<style>
    /* Reset & Layout */
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #1e1e1e;
    }

    .container {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        /* Ensure it's visible but we override its styles */
    }

    .main-container {
        display: flex;
        height: calc(100vh - 60px);
        width: 100%;
        background-color: #202124;
        position: relative;
    }

    /* Editor Panel */
    .editor-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #333;
        min-width: 400px;
    }

    .panel-header {
        background: #252526;
        color: #cccccc;
        padding: 10px 20px;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
    }

    .status-badge {
        font-size: 10px;
        background: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .CodeMirror {
        flex: 1;
        font-family: 'Fira Code', monospace;
        font-size: 14px;
    }

    /* Video Panel */
    .video-panel {
        flex: 1;
        position: relative;
        background: #202124;
    }

    .meet-container {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .video-grid {
        flex: 1;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .remote-video-wrapper {
        width: 100%;
        height: 100%;
        max-width: 1200px;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background: #3c4043;
    }

    #remoteVideo {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .local-video-wrapper {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 200px;
        /* Smaller PIP for split view */
        height: 115px;
        background: #3c4043;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.1);
        z-index: 100;
        transition: all 0.3s ease;
    }

    .local-video-wrapper:hover {
        width: 250px;
        height: 144px;
    }

    #localVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    .participant-label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
    }

    /* Control Bar */
    .control-bar {
        height: 70px;
        background: #202124;
        display: flex;
        justify-content: center;
        align-items: center;
        padding-bottom: 10px;
    }

    .control-group {
        display: flex;
        gap: 10px;
        background: #3c4043;
        padding: 8px 16px;
        border-radius: 50px;
    }

    .control-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: #3c4043;
        color: white;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background 0.2s;
    }

    .control-btn:hover {
        background: #4a4e51;
    }

    .control-btn.active-off {
        background: #ea4335;
        color: white;
    }

    .control-btn.active-off:hover {
        background: #d93025;
    }

    .btn-end-call {
        background: #ea4335;
        width: 50px;
        border-radius: 30px;
    }

    .btn-end-call:hover {
        background: #d93025;
    }

    /* Toast */
    #toast-container {
        position: fixed;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
    }

    .toast {
        background: #3c4043;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        margin-top: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s, fadeOut 0.3s 2.7s forwards;
    }

    @keyframes slideIn {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }

    /* Chat Sidebar */
    .chat-sidebar {
        position: absolute;
        top: 0;
        right: -320px;
        /* Hidden by default */
        width: 320px;
        height: 100%;
        background: #fff;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
        z-index: 200;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
    }

    .chat-sidebar.open {
        right: 0;
    }

    .chat-header {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #333;
    }

    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .chat-message {
        max-width: 85%;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.4;
    }

    .chat-message.self {
        align-self: flex-end;
        background: #e3f2fd;
        color: #1565c0;
        border-bottom-right-radius: 2px;
    }

    .chat-message.remote {
        align-self: flex-start;
        background: #fff;
        color: #333;
        border: 1px solid #eee;
        border-bottom-left-radius: 2px;
    }

    .message-meta {
        font-size: 10px;
        margin-bottom: 4px;
        opacity: 0.7;
        display: flex;
        justify-content: space-between;
    }

    .chat-input-area {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: #fff;
    }

    #chatInput {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
    }

    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: #5f6368;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .icon-btn:hover {
        background: #f1f3f4;
        border-radius: 50%;
    }

    .send-btn {
        color: #1a73e8;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const ROOM_ID = "{{ meeting_link }}";
    const USERNAME = "{{ session.name }}";
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="{{ url_for('static', filename='js/webrtc.js') }}"></script>
<script src="{{ url_for('static', filename='js/editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // Pre-fill code if exists
    const savedCode = `{{ interview.code_content|default('# Write your code here...', true)|safe }}`;
    if (editor && savedCode) {
        editor.setValue(savedCode);
    }

    // Scroll chat to bottom
    const chatMsgs = document.getElementById('chatMessages');
    if (chatMsgs) {
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
    }

    // Update button states based on tracks
    const micBtn = document.getElementById('toggleMic');
    const camBtn = document.getElementById('toggleCam');

    if (micBtn) {
        micBtn.addEventListener('click', () => {
            const icon = micBtn.querySelector('.material-icons');
            if (micBtn.classList.contains('active-off')) {
                micBtn.classList.remove('active-off');
                icon.textContent = 'mic';
            } else {
                micBtn.classList.add('active-off');
                icon.textContent = 'mic_off';
            }
        });
    }

    if (camBtn) {
        camBtn.addEventListener('click', () => {
            const icon = camBtn.querySelector('.material-icons');
            if (camBtn.classList.contains('active-off')) {
                camBtn.classList.remove('active-off');
                icon.textContent = 'videocam';
            } else {
                camBtn.classList.add('active-off');
                icon.textContent = 'videocam_off';
            }
        });
    }

    function confirmEndCall() {
        if (confirm("Are you sure you want to end the interview?")) {
            window.location.href = "{{ url_for('main.dashboard') }}";
        }
    }
</script>
{% endblock %}