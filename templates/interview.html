{% extends 'base.html' %}

{% block title %}Interview Room - AI Interview System{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">

<!-- Pre-join Screen (Candidate Only) -->
{% if role == 'candidate' and join_status != 'approved' %}
<div id="preJoinScreen" class="overlay-screen">
    <div class="card">
        <h2>Ready to Join?</h2>
        <p>Please check your camera and microphone before joining.</p>
        <div class="preview-area">
            <video id="previewVideo" autoplay muted playsinline></video>
        </div>
        <div class="actions">
            <button id="checkDevicesBtn" class="btn-primary">Check Devices</button>
            <button id="askToJoinBtn" class="btn-success" disabled>Ask to Join</button>
        </div>
        <div id="deviceStatus" class="status-text"></div>
    </div>
</div>

<div id="waitingScreen" class="overlay-screen" style="display: none;">
    <div class="card">
        <h2>Waiting for Approval</h2>
        <p>The interviewer has been notified. Please wait...</p>
        <div class="loader"></div>
    </div>
</div>
{% endif %}

<!-- Interviewer Approval Popup -->
{% if role == 'interviewer' %}
<div id="approvalPopup" class="popup-overlay" style="display: none;">
    <div class="popup-card">
        <h3>Join Request</h3>
        <p><span id="requestingUser">Candidate</span> wants to join the interview.</p>
        <div class="popup-actions">
            <button id="denyJoinBtn" class="btn-danger">Deny</button>
            <button id="approveJoinBtn" class="btn-success">Admit</button>
        </div>
    </div>
</div>
{% endif %}

<div class="main-container" id="mainContainer" {% if role=='candidate' and join_status !='approved'
    %}style="display: none;" {% endif %}>
    <!-- Left Panel: Code Editor -->
    <div class="editor-panel">
        <div class="panel-header">
            <span>Python Editor</span>
            <span class="status-badge">Live Sync Active</span>
        </div>
        <textarea id="codeEditor"># Write your code here...</textarea>
    </div>

    <!-- Right Panel: Video Call -->
    <div class="video-panel">
        <div class="meet-container">
            <div class="video-grid">
                <!-- Remote Video (Main) -->
                <div class="remote-video-wrapper">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="participant-label">
                        {% if role == 'interviewer' %}
                        Candidate: {{ interview.candidate_name }}
                        {% else %}
                        Interviewer: {{ interview.interviewer_name }}
                        {% endif %}
                    </div>
                </div>

                <!-- Local Video (PIP) -->
                <div class="local-video-wrapper">
                    <video id="localVideo" autoplay playsinline muted></video>
                    <div class="participant-label">You ({{ role|title }})</div>
                </div>
            </div>

            <!-- Control Bar -->
            <div class="control-bar">
                <div class="control-group">
                    <button id="toggleMic" class="control-btn" title="Toggle Microphone"><span
                            class="material-icons">mic</span></button>
                    <button id="toggleCam" class="control-btn" title="Toggle Camera"><span
                            class="material-icons">videocam</span></button>
                    <button id="toggleChat" class="control-btn" title="Chat"><span
                            class="material-icons">chat</span></button>
                    <button id="shareScreen" class="control-btn" title="Share Screen"><span
                            class="material-icons">present_to_all</span></button>

                    {% if role == 'interviewer' %}
                    <button class="control-btn btn-end-call" title="End Interview" onclick="confirmEndCall()">
                        <span class="material-icons">call_end</span>
                    </button>
                    {% else %}
                    <a href="{{ url_for('main.dashboard') }}" class="control-btn btn-end-call" title="Leave Call">
                        <span class="material-icons">call_end</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Sidebar -->
    <div id="chatSidebar" class="chat-sidebar">
        <div class="chat-header">
            <span>Chat</span>
            <button id="closeChat" class="icon-btn"><span class="material-icons">close</span></button>
        </div>
        <div id="chatMessages" class="chat-messages">
            {% for msg in chat_history %}
            <div class="chat-message {% if msg.sender_username == session.name %}self{% else %}remote{% endif %}">
                <div class="message-meta">
                    <span class="message-user">{% if msg.sender_username == session.name %}You{% else %}{{
                        msg.sender_username }}{% endif %}</span>
                    <span class="message-time">{{ msg.timestamp }}</span>
                </div>
                <div class="message-content">{{ msg.message }}</div>
            </div>
            {% endfor %}
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Send a message...">
            <button id="sendChat" class="icon-btn send-btn"><span class="material-icons">send</span></button>
        </div>
    </div>

    <div id="toast-container"></div>
</div>

<style>
    /* Reset & Layout */
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #1e1e1e;
    }

    .container {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        /* Ensure it's visible but we override its styles */
    }

    .main-container {
        display: flex;
        height: calc(100vh - 60px);
        width: 100%;
        background-color: #202124;
        position: relative;
    }

    /* Editor Panel */
    .editor-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #333;
        min-width: 400px;
    }

    .panel-header {
        background: #252526;
        color: #cccccc;
        padding: 10px 20px;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
    }

    .status-badge {
        font-size: 10px;
        background: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .CodeMirror {
        flex: 1;
        font-family: 'Fira Code', monospace;
        font-size: 14px;
    }

    /* Video Panel */
    .video-panel {
        flex: 1;
        position: relative;
        background: #202124;
    }

    .meet-container {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .video-grid {
        flex: 1;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .remote-video-wrapper {
        width: 100%;
        height: 100%;
        max-width: 1200px;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background: #3c4043;
    }

    #remoteVideo {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .local-video-wrapper {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 200px;
        /* Smaller PIP for split view */
        height: 115px;
        background: #3c4043;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.1);
        z-index: 100;
        transition: all 0.3s ease;
    }

    .local-video-wrapper:hover {
        width: 250px;
        height: 144px;
    }

    #localVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    .participant-label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
    }

    /* Control Bar */
    .control-bar {
        height: 70px;
        background: #202124;
        display: flex;
        justify-content: center;
        align-items: center;
        padding-bottom: 10px;
    }

    .control-group {
        display: flex;
        gap: 10px;
        background: #3c4043;
        padding: 8px 16px;
        border-radius: 50px;
    }

    .control-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: #3c4043;
        color: white;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background 0.2s;
    }

    .control-btn:hover {
        background: #4a4e51;
    }

    .control-btn.active-off {
        background: #ea4335;
        color: white;
    }

    .control-btn.active-off:hover {
        background: #d93025;
    }

    .btn-end-call {
        background: #ea4335;
        width: 50px;
        border-radius: 30px;
    }

    .btn-end-call:hover {
        background: #d93025;
    }

    /* Toast */
    #toast-container {
        position: fixed;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
    }

    .toast {
        background: #3c4043;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        margin-top: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s, fadeOut 0.3s 2.7s forwards;
    }

    @keyframes slideIn {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }

    /* Chat Sidebar */
    .chat-sidebar {
        position: absolute;
        top: 0;
        right: -320px;
        /* Hidden by default */
        width: 320px;
        height: 100%;
        background: #fff;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
        z-index: 200;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
    }

    .chat-sidebar.open {
        right: 0;
    }

    .chat-header {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #333;
    }

    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .chat-message {
        max-width: 85%;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.4;
    }

    .chat-message.self {
        align-self: flex-end;
        background: #e3f2fd;
        color: #1565c0;
        border-bottom-right-radius: 2px;
    }

    .chat-message.remote {
        align-self: flex-start;
        background: #fff;
        color: #333;
        border: 1px solid #eee;
        border-bottom-left-radius: 2px;
    }

    .message-meta {
        font-size: 10px;
        margin-bottom: 4px;
        opacity: 0.7;
        display: flex;
        justify-content: space-between;
    }

    .chat-input-area {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: #fff;
    }

    #chatInput {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
    }

    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: #5f6368;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .icon-btn:hover {
        background: #f1f3f4;
        border-radius: 50%;
    }

    .send-btn {
        color: #1a73e8;
    }

    /* Overlay Screens */
    .overlay-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #202124;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    .card {
        background: #3c4043;
        padding: 30px;
        border-radius: 8px;
        text-align: center;
        color: white;
        max-width: 500px;
        width: 90%;
    }

    .preview-area {
        width: 100%;
        height: 300px;
        background: #000;
        margin: 20px 0;
        border-radius: 8px;
        overflow: hidden;
    }

    #previewVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    .actions {
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    .btn-primary {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-success {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-danger {
        background: #ea4335;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .status-text {
        margin-top: 10px;
        font-size: 14px;
        color: #aaa;
    }

    /* Loader */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Popup */
    .popup-overlay {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
    }

    .popup-card {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        width: 300px;
        animation: slideInRight 0.3s;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
        }

        to {
            transform: translateX(0);
        }
    }

    .popup-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const ROOM_ID = "{{ meeting_link }}";
    const USERNAME = "{{ session.name }}";
    const ROLE = "{{ role }}";
    const JOIN_STATUS = "{{ join_status }}";
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="{{ url_for('static', filename='js/webrtc.js') }}"></script>
<script src="{{ url_for('static', filename='js/editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // Pre-fill code if exists
    const savedCode = `{{ interview.code_content|default('# Write your code here...', true)|safe }}`;
    if (editor && savedCode) {
        editor.setValue(savedCode);
    }

    // Scroll chat to bottom
    const chatMsgs = document.getElementById('chatMessages');
    if (chatMsgs) {
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
    }

    // Update button states
    const micBtn = document.getElementById('toggleMic');
    const camBtn = document.getElementById('toggleCam');

    if (micBtn) {
        micBtn.addEventListener('click', () => {
            const icon = micBtn.querySelector('.material-icons');
            if (micBtn.classList.contains('active-off')) {
                micBtn.classList.remove('active-off');
                icon.textContent = 'mic';
            } else {
                micBtn.classList.add('active-off');
                icon.textContent = 'mic_off';
            }
        });
    }

    if (camBtn) {
        camBtn.addEventListener('click', () => {
            const icon = camBtn.querySelector('.material-icons');
            if (camBtn.classList.contains('active-off')) {
                camBtn.classList.remove('active-off');
                icon.textContent = 'videocam';
            } else {
                camBtn.classList.add('active-off');
                icon.textContent = 'videocam_off';
            }
        });
    }

    function confirmEndCall() {
        if (confirm("Are you sure you want to end the interview?")) {
            window.location.href = "{{ url_for('main.dashboard') }}";
        }
    }

    // Join Request Logic
    const preJoinScreen = document.getElementById('preJoinScreen');
    const waitingScreen = document.getElementById('waitingScreen');
    const mainContainer = document.getElementById('mainContainer');
    const previewVideo = document.getElementById('previewVideo');
    const checkDevicesBtn = document.getElementById('checkDevicesBtn');
    const askToJoinBtn = document.getElementById('askToJoinBtn');
    const deviceStatus = document.getElementById('deviceStatus');
    const approvalPopup = document.getElementById('approvalPopup');
    const approveJoinBtn = document.getElementById('approveJoinBtn');
    const denyJoinBtn = document.getElementById('denyJoinBtn');

    // Candidate Flow
    if (ROLE === 'candidate' && JOIN_STATUS !== 'approved') {
        // Device Check
        if (checkDevicesBtn) {
            checkDevicesBtn.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    previewVideo.srcObject = stream;
                    deviceStatus.textContent = "Camera and Microphone are working!";
                    deviceStatus.style.color = "#28a745";
                    askToJoinBtn.disabled = false;
                } catch (err) {
                    console.error(err);
                    deviceStatus.textContent = "Error accessing devices: " + err.message;
                    deviceStatus.style.color = "#ea4335";
                }
            });
        }

        // Ask to Join
        if (askToJoinBtn) {
            askToJoinBtn.addEventListener('click', () => {
                socket.emit('request-join', { room: ROOM_ID, username: USERNAME });
                preJoinScreen.style.display = 'none';
                waitingScreen.style.display = 'flex';

                // Stop preview stream
                if (previewVideo.srcObject) {
                    previewVideo.srcObject.getTracks().forEach(track => track.stop());
                }
            });
        }

        // Listen for approval
        socket.on('join-approved', () => {
            waitingScreen.style.display = 'none';
            mainContainer.style.display = 'flex';
            initializeMeeting(); // Start WebRTC
        });

        socket.on('join-rejected', () => {
            alert("Your request to join was denied.");
            window.location.href = "{{ url_for('main.dashboard') }}";
        });
    } else {
        // Interviewer or Approved Candidate
        if (typeof initializeMeeting === 'function') {
            initializeMeeting();
        }
    }

    // Interviewer Flow
    if (ROLE === 'interviewer') {
        socket.on('join-request', (data) => {
            const userSpan = document.getElementById('requestingUser');
            if (userSpan) userSpan.textContent = data.username;
            if (approvalPopup) approvalPopup.style.display = 'block';
        });

        if (approveJoinBtn) {
            approveJoinBtn.addEventListener('click', () => {
                socket.emit('approve-join', { room: ROOM_ID });
                if (approvalPopup) approvalPopup.style.display = 'none';
            });
        }

        if (denyJoinBtn) {
            denyJoinBtn.addEventListener('click', () => {
                socket.emit('reject-join', { room: ROOM_ID });
                if (approvalPopup) approvalPopup.style.display = 'none';
            });
        }
    }
</script>
{% endblock %}