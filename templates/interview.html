<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Session - NeuroHire</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0a0a0a',
                        secondary: '#121212',
                        accent: '#8b5cf6', // Violet 500
                        accentGlow: '#7c3aed', // Violet 600
                        surface: '#18181b',
                        editor: '#0d0d0d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scan': 'scan 2s linear infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { top: '0%' },
                            '100%': { top: '100%' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Fonts & Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">

    <style>
        body {
            background-color: #050505;
            color: #ffffff;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(20, 20, 25, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-header {
            background: rgba(5, 5, 5, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Editor Styles */
        .editor-gutter {
            background: #0a0a0a;
            color: #555;
            text-align: right;
            padding-right: 1rem;
            border-right: 1px solid #222;
        }

        .CodeMirror {
            height: 100% !important;
            background: #0d0d0d !important;
            font-family: 'JetBrains Mono', monospace !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        /* Video Overlays */
        .scanner-line {
            width: 100%;
            height: 2px;
            background: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 10px #22c55e;
            position: absolute;
            top: 0;
            left: 0;
            animation: scan 3s ease-in-out infinite;
            opacity: 0.5;
            pointer-events: none;
        }

        .face-box {
            position: absolute;
            border: 1px dashed rgba(168, 85, 247, 0.5);
            top: 20%;
            left: 30%;
            width: 40%;
            height: 50%;
            border-radius: 20%;
            pointer-events: none;
        }

        /* Overlay Screens (Pre-join, Waiting, Popup) */
        .overlay-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .overlay-card {
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .preview-area {
            width: 100%;
            height: 300px;
            background: #000;
            margin: 1.5rem 0;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #previewVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* Popup */
        .popup-overlay {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 3000;
        }

        .popup-card {
            background: #18181b;
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            width: 300px;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(20px);
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <!-- Pre-join Screen (Candidate Only) -->
    {% if role == 'candidate' and join_status != 'approved' %}
    <div id="preJoinScreen" class="overlay-screen">
        <div class="overlay-card">
            <h2 class="text-2xl font-bold text-white mb-2">Ready to Join?</h2>
            <p class="text-gray-400">Please check your camera and microphone.</p>
            <div class="preview-area">
                <video id="previewVideo" autoplay muted playsinline></video>
            </div>
            <div class="flex justify-center gap-4">
                <button id="checkDevicesBtn"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">Check
                    Devices</button>
                <button id="askToJoinBtn"
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>Ask to Join</button>
            </div>
            <div id="deviceStatus" class="mt-4 text-sm text-gray-500"></div>
        </div>
    </div>

    <div id="waitingScreen" class="overlay-screen" style="display: none;">
        <div class="overlay-card">
            <h2 class="text-2xl font-bold text-white mb-2">Waiting for Approval</h2>
            <p class="text-gray-400 mb-6">The interviewer has been notified. Please wait...</p>
            <div class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mx-auto">
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Interviewer Approval Popup -->
    {% if role == 'interviewer' %}
    <div id="approvalPopup" class="popup-overlay" style="display: none;">
        <div class="popup-card">
            <h3 class="text-lg font-bold text-white mb-2">Join Request</h3>
            <p class="text-gray-400 text-sm mb-4"><span id="requestingUser"
                    class="text-purple-400 font-medium">Candidate</span> wants to join.</p>
            <div class="flex justify-end gap-2">
                <button id="denyJoinBtn"
                    class="px-3 py-1.5 bg-red-500/10 hover:bg-red-500/20 text-red-400 text-xs font-bold rounded border border-red-500/20 transition-colors">Deny</button>
                <button id="approveJoinBtn"
                    class="px-3 py-1.5 bg-green-500/10 hover:bg-green-500/20 text-green-400 text-xs font-bold rounded border border-green-500/20 transition-colors">Admit</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Workspace -->
    <div id="mainContainer" class="flex-1 flex flex-col h-full w-full" {% if role=='candidate' and join_status
        !='approved' %}style="display: none;" {% endif %}>

        <!-- Header -->
        <header class="h-14 glass-header flex items-center justify-between px-4 z-50 shrink-0">
            <!-- Left: Branding & Session Info -->
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div
                        class="w-6 h-6 bg-gradient-to-tr from-purple-600 to-indigo-600 rounded flex items-center justify-center">
                        <i class="fa-solid fa-brain text-white text-[10px]"></i>
                    </div>
                    <span class="font-display font-bold text-white tracking-tight">Neuro<span
                            class="text-purple-400">Hire</span></span>
                </div>
                <div class="h-4 w-px bg-gray-700"></div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-400">Session ID:</span>
                    <span class="text-xs font-mono text-purple-300">{{ meeting_link[:8] }}...</span>
                </div>
                <div id="statusBadge" class="px-2 py-0.5 rounded flex items-center gap-2 
                    {% if interview.status == 'completed' %}bg-green-500/10 border border-green-500/20
                    {% elif interview.status == 'cancelled' %}bg-gray-500/10 border border-gray-500/20
                    {% else %}bg-red-500/10 border border-red-500/20{% endif %}">
                    <div class="w-1.5 h-1.5 rounded-full 
                        {% if interview.status == 'completed' %}bg-green-500
                        {% elif interview.status == 'cancelled' %}bg-gray-500
                        {% else %}bg-red-500 animate-pulse{% endif %}"></div>
                    <span class="text-[10px] font-bold uppercase tracking-wider" id="statusText"
                        {% if interview.status == 'completed' %}class="text-green-400"
                        {% elif interview.status == 'cancelled' %}class="text-gray-400"
                        {% else %}class="text-red-400"{% endif %}>
                        {% if interview.status == 'completed' %}Completed
                        {% elif interview.status == 'cancelled' %}Cancelled
                        {% else %}Live{% endif %}
                    </span>
                </div>
            </div>

            <!-- Center: Timer -->
            <div
                class="absolute left-1/2 transform -translate-x-1/2 bg-black/50 border border-gray-800 rounded px-3 py-1 flex items-center gap-2">
                <i class="fa-regular fa-clock text-gray-400 text-xs"></i>
                <span class="font-mono text-sm font-medium text-white">00:00:00</span>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-3">
                {% if role == 'interviewer' %}
                    {% if resume_url %}
                    <button
                        id="viewResumeBtn"
                        type="button"
                        class="bg-gray-800 hover:bg-gray-700 text-white text-xs font-bold px-4 py-1.5 rounded transition-colors flex items-center gap-2 border border-gray-700"
                    >
                        <i class="fa-solid fa-file-lines"></i> View Resume
                    </button>
                    {% endif %}
                    {% if interview.status != 'completed' %}
                    <button
                        id="completeInterviewBtn"
                        class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-4 py-1.5 rounded transition-colors flex items-center gap-2"
                        onclick="markAsCompleted()">
                        <i class="fa-solid fa-check-circle"></i> Mark as Completed
                    </button>
                    {% endif %}
                <button
                    class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-4 py-1.5 rounded transition-colors flex items-center gap-2"
                    onclick="confirmEndCall()">
                    <i class="fa-solid fa-phone-slash"></i> End Interview
                </button>
                {% else %}
                {% if resume_url %}
                <button
                    id="viewResumeBtn"
                    type="button"
                    class="bg-gray-800 hover:bg-gray-700 text-white text-xs font-bold px-4 py-1.5 rounded transition-colors flex items-center gap-2 border border-gray-700"
                >
                    <i class="fa-solid fa-file-lines"></i> View Resume
                </button>
                {% endif %}
                <a href="{{ url_for('main.dashboard') }}"
                    class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-4 py-1.5 rounded transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-phone-slash"></i> Leave Call
                </a>
                {% endif %}
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">

            <!-- LEFT PANEL: Code Editor (65%) -->
            <div class="flex-1 flex flex-col border-r border-gray-800 bg-editor relative min-w-0">

                <!-- Editor Toolbar -->
                <div class="h-10 border-b border-gray-800 flex items-center justify-between px-4 bg-[#0a0a0a] shrink-0">
                    <div class="flex items-center gap-4">
                        <div
                            class="flex items-center gap-2 text-xs text-gray-400 hover:text-white cursor-pointer transition-colors">
                            <i class="fa-regular fa-folder"></i> Files
                        </div>
                        <div class="h-4 w-px bg-gray-800"></div>
                        <div class="flex items-center gap-2">
                            <select
                                class="bg-transparent text-xs text-purple-300 font-medium focus:outline-none cursor-pointer">
                                <option>Python 3.9</option>
                                <option>JavaScript (Node)</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button class="text-gray-400 hover:text-white px-2"><i
                                class="fa-solid fa-gear text-xs"></i></button>
                        <button
                            class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-3 py-1 rounded flex items-center gap-1 transition-colors">
                            <i class="fa-solid fa-play text-[10px]"></i> Run Code
                        </button>
                    </div>
                </div>

                <!-- Code Area -->
                <div class="flex-1 relative overflow-hidden">
                    <textarea id="codeEditor"
                        class="w-full h-full bg-transparent text-white font-mono text-sm p-4 focus:outline-none resize-none"># Write your code here...</textarea>
                </div>

                <!-- Terminal / Output (Collapsed by default or small) -->
                <div class="h-32 border-t border-gray-800 bg-[#0a0a0a] flex flex-col shrink-0">
                    <div class="h-8 border-b border-gray-800 flex items-center px-4 gap-4">
                        <span
                            class="text-xs font-bold text-gray-300 border-b-2 border-purple-500 h-full flex items-center">Terminal</span>
                    </div>
                    <div class="flex-1 p-3 font-mono text-xs text-gray-400 overflow-auto">
                        <span class="text-green-400">‚ûú ~</span> Ready...
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: Video & AI (35%) -->
            <div class="w-[400px] flex flex-col bg-surface border-l border-gray-800 shrink-0">

                <!-- Video Section -->
                <div class="h-[40%] bg-black relative border-b border-gray-800 shrink-0">
                    <!-- Remote Video -->
                    <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover opacity-90"></video>

                    <!-- AI Overlays - Real Face Detection -->
                    <div class="absolute inset-0 pointer-events-none" id="faceDetectionOverlay">
                        <canvas id="faceDetectionCanvas" class="absolute inset-0 w-full h-full"></canvas>
                        <div class="absolute top-2 left-2 flex flex-col gap-1" id="faceDetectionStatus">
                            <span
                                class="bg-black/60 text-gray-400 text-[10px] px-1.5 py-0.5 rounded border border-gray-500/30">
                                <i class="fa-solid fa-spinner fa-spin mr-1"></i> Initializing...
                            </span>
                        </div>
                    </div>

                    <!-- Local Video (PIP) -->
                    <div
                        class="absolute bottom-4 right-4 w-28 h-20 bg-gray-800 rounded-lg overflow-hidden border border-gray-600 shadow-xl z-10">
                        <video id="localVideo" autoplay playsinline muted
                            class="w-full h-full object-cover transform -scale-x-100"></video>
                        <div class="absolute bottom-1 left-1 text-[8px] text-white bg-black/50 px-1 rounded">You</div>
                    </div>

                    <!-- Video Controls (Floating) -->
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-20">
                        <button id="toggleMic"
                            class="w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 text-white flex items-center justify-center border border-gray-600 transition-colors">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                        <button id="toggleCam"
                            class="w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 text-white flex items-center justify-center border border-gray-600 transition-colors">
                            <i class="fa-solid fa-video"></i>
                        </button>
                        <button id="shareScreen"
                            class="w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 text-white flex items-center justify-center border border-gray-600 transition-colors">
                            <i class="fa-solid fa-desktop"></i>
                        </button>
                    </div>
                </div>

                <!-- Tabs: AI & Chat -->
                <div class="flex-1 flex flex-col bg-[#0f0f12] overflow-hidden">
                    <div class="flex border-b border-gray-800 shrink-0">
                        <button
                            class="flex-1 py-3 text-xs font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-colors"
                            onclick="switchTab('ai')">
                            <i class="fa-solid fa-robot mr-1"></i> AI Copilot
                        </button>
                        <button
                            class="flex-1 py-3 text-xs font-bold text-purple-400 border-b-2 border-purple-500 bg-purple-500/5"
                            onclick="switchTab('chat')">
                            <i class="fa-regular fa-comments mr-1"></i> Chat
                        </button>
                    </div>

                    <!-- Chat Content (Active by default for now) -->
                    <div id="chatTab" class="flex-1 flex flex-col overflow-hidden">
                        <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-4">
                            {% for msg in chat_history %}
                            <div
                                class="flex flex-col {% if msg.sender_username == session.name %}items-end{% else %}items-start{% endif %}">
                                <div class="text-[10px] text-gray-500 mb-1">
                                    {% if msg.sender_username == session.name %}You{% else %}{{ msg.sender_username }}{%
                                    endif %} ‚Ä¢ {{ msg.timestamp }}
                                </div>
                                <div
                                    class="max-w-[85%] px-3 py-2 rounded-lg text-xs {% if msg.sender_username == session.name %}bg-purple-600/20 text-purple-200 border border-purple-600/30{% else %}bg-gray-800 text-gray-300 border border-gray-700{% endif %}">
                                    {{ msg.message }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Chat Input -->
                        <div class="p-3 border-t border-gray-800 bg-[#0a0a0a] shrink-0">
                            <div class="relative">
                                <input type="text" id="chatInput" placeholder="Type a message..."
                                    class="w-full bg-[#1a1a1d] text-white text-xs rounded-lg pl-3 pr-10 py-2.5 focus:outline-none focus:ring-1 focus:ring-purple-500 border border-gray-700">
                                <button id="sendChat"
                                    class="absolute right-2 top-2 text-gray-400 hover:text-purple-400 transition-colors">
                                    <i class="fa-solid fa-paper-plane text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- AI Content (Hidden by default) -->
                    <div id="aiTab" class="hidden flex-1 p-4 overflow-y-auto space-y-4">
                        <!-- Alert Card -->
                        <div class="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs font-bold text-yellow-500"><i
                                        class="fa-solid fa-triangle-exclamation mr-1"></i> Logical Edge Case</span>
                            </div>
                            <p class="text-xs text-gray-400 leading-relaxed">
                                Candidate missed checking for <code class="text-yellow-300">head is null</code>.
                            </p>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <div id="toast-container" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50"></div>

    <!-- Resume Modal -->
    {% if resume_url %}
    <div id="resumeModal" class="overlay-screen" style="display: none;">
        <div class="overlay-card" style="max-width: 1000px; width: 95%; text-align: left;">
            <div class="flex items-start justify-between gap-4">
                <div>
                    <h2 class="text-xl font-bold text-white">Candidate Resume</h2>
                    <p class="text-xs text-gray-400 mt-1">
                        {{ resume_original_name or 'Resume' }}
                    </p>
                </div>
                <button
                    id="closeResumeBtn"
                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors text-xs font-bold"
                    type="button"
                >
                    Close
                </button>
            </div>

            <div class="mt-4">
                <iframe
                    id="resumeFrame"
                    src=""
                    class="w-full rounded-lg border border-gray-700"
                    style="height: 70vh; background: #0a0a0a;"
                ></iframe>

                <div id="resumeUnsupported" class="hidden mt-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                    <div class="text-yellow-400 text-sm font-bold mb-1">
                        Preview not available for this file type.
                    </div>
                    <div class="text-gray-300 text-sm">
                        Click below to open/download the resume:
                        <a
                            id="resumeOpenLink"
                            href="{{ resume_url }}"
                            target="_blank"
                            class="text-purple-300 underline"
                        >Open resume</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Face Detection Library -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const ROOM_ID = "{{ meeting_link }}";
        const USERNAME = "{{ session.name }}";
        const ROLE = "{{ role }}";
        const JOIN_STATUS = "{{ join_status }}";
        const RESUME_URL = {{ (resume_url or None) | tojson }};
        const RESUME_NAME = {{ (resume_original_name or 'Resume') | tojson }};
        const RESUME_EXT = {{ (resume_ext or '') | tojson }};
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="{{ url_for('static', filename='js/webrtc.js') }}"></script>
    <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    <script src="{{ url_for('static', filename='js/face-detection.js') }}"></script>
    <script>
        // Pre-fill code if exists
        const savedCode = `{{ interview.code_content|default('# Write your code here...', true)|safe }}`;
        if (editor && savedCode) {
            editor.setValue(savedCode);
        }

        // Scroll chat to bottom
        const chatMsgs = document.getElementById('chatMessages');
        if (chatMsgs) {
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }

        // Resume modal logic
        (function () {
            const btn = document.getElementById('viewResumeBtn');
            const modal = document.getElementById('resumeModal');
            const closeBtn = document.getElementById('closeResumeBtn');
            const frame = document.getElementById('resumeFrame');
            const unsupported = document.getElementById('resumeUnsupported');
            const openLink = document.getElementById('resumeOpenLink');

            if (!btn || !modal || !RESUME_URL) return;

            function openModal() {
                modal.style.display = 'flex';
                const ext = (RESUME_EXT || '').toLowerCase();
                const canPreview = ext === 'pdf';

                if (openLink) openLink.href = RESUME_URL;

                if (canPreview) {
                    if (unsupported) unsupported.classList.add('hidden');
                    if (frame) {
                        frame.classList.remove('hidden');
                        frame.src = RESUME_URL;
                    }
                } else {
                    if (frame) {
                        frame.src = '';
                        frame.classList.add('hidden');
                    }
                    if (unsupported) unsupported.classList.remove('hidden');
                }
            }

            function closeModal() {
                modal.style.display = 'none';
                if (frame) frame.src = '';
            }

            btn.addEventListener('click', openModal);
            if (closeBtn) closeBtn.addEventListener('click', closeModal);

            // Click outside card to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // ESC to close
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.style.display === 'flex') closeModal();
            });
        })();

        // Initialize Face Detection when video is ready
        function initializeFaceDetectionForInterview() {
            const localVideo = document.getElementById('localVideo');
            const statusElement = document.getElementById('faceDetectionStatus');
            
            if (!localVideo) return;
            
            // Wait for video stream
            const checkVideo = setInterval(() => {
                if (localVideo.srcObject && localVideo.videoWidth > 0) {
                    clearInterval(checkVideo);
                    
                    // Update status
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <span class="bg-black/60 text-yellow-400 text-[10px] px-1.5 py-0.5 rounded border border-yellow-500/30">
                                <i class="fa-solid fa-spinner fa-spin mr-1"></i> Loading AI models...
                            </span>
                        `;
                    }
                    
                    // Initialize face detection
                    if (typeof window.faceDetection !== 'undefined' && typeof faceapi !== 'undefined') {
                        // Load models first
                        faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/')
                            .then(() => faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'))
                            .then(() => {
                                console.log('Face detection models loaded');
                                if (statusElement) {
                                    statusElement.innerHTML = `
                                        <span class="bg-black/60 text-green-400 text-[10px] px-1.5 py-0.5 rounded border border-green-500/30">
                                            <i class="fa-solid fa-check-circle mr-1"></i> AI Active
                                        </span>
                                    `;
                                }
                                // Start detection
                                window.faceDetection.start(localVideo);
                            })
                            .catch(error => {
                                console.error('Error loading face detection models:', error);
                                if (statusElement) {
                                    statusElement.innerHTML = `
                                        <span class="bg-black/60 text-red-400 text-[10px] px-1.5 py-0.5 rounded border border-red-500/30">
                                            <i class="fa-solid fa-exclamation-triangle mr-1"></i> AI Unavailable
                                        </span>
                                    `;
                                }
                            });
                    } else {
                        console.error('Face detection library not loaded');
                        if (statusElement) {
                            statusElement.innerHTML = `
                                <span class="bg-black/60 text-red-400 text-[10px] px-1.5 py-0.5 rounded border border-red-500/30">
                                    <i class="fa-solid fa-exclamation-triangle mr-1"></i> AI Library Missing
                                </span>
                            `;
                        }
                    }
                }
            }, 500);
            
            // Stop checking after 30 seconds
            setTimeout(() => clearInterval(checkVideo), 30000);
        }

        // Initialize face detection after page load
        window.addEventListener('load', () => {
            setTimeout(initializeFaceDetectionForInterview, 2000);
        });

        // Also try when meeting initializes
        if (typeof initializeMeeting === 'function') {
            const originalInit = initializeMeeting;
            window.initializeMeeting = function() {
                originalInit();
                setTimeout(initializeFaceDetectionForInterview, 3000);
            };
        }

        // Listen for cheat alerts (Interviewer only)
        {% if role == 'interviewer' %}
        if (typeof socket !== 'undefined') {
            socket.on('cheat-alert', (data) => {
                console.warn('Cheat alert received:', data);
                
                // Determine severity styling
                const severity = data.severity || 'low';
                let bgColor = 'bg-red-500/10';
                let borderColor = 'border-red-500/20';
                let textColor = 'text-red-500';
                let icon = 'fa-exclamation-triangle';
                let emoji = '‚ö†Ô∏è';
                
                if (severity === 'high') {
                    bgColor = 'bg-red-600/20';
                    borderColor = 'border-red-600/40';
                    textColor = 'text-red-400';
                    icon = 'fa-exclamation-circle';
                    emoji = 'üî¥';
                } else if (severity === 'medium') {
                    bgColor = 'bg-yellow-500/10';
                    borderColor = 'border-yellow-500/20';
                    textColor = 'text-yellow-400';
                    icon = 'fa-exclamation-triangle';
                    emoji = 'üü°';
                } else {
                    bgColor = 'bg-orange-500/10';
                    borderColor = 'border-orange-500/20';
                    textColor = 'text-orange-400';
                    icon = 'fa-eye';
                    emoji = 'üü†';
                }
                
                // Show alert to interviewer
                const alertMessage = `${emoji} ${data.message}`;
                if (typeof showToast === 'function') {
                    showToast(alertMessage);
                } else {
                    alert(alertMessage);
                }
                
                // Add to AI tab for logging
                const aiTab = document.getElementById('aiTab');
                if (aiTab) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `p-3 ${bgColor} border ${borderColor} rounded-lg mb-2`;
                    alertDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-bold ${textColor}">
                                <i class="fa-solid ${icon} mr-1"></i> ${data.type.replace(/-/g, ' ').toUpperCase()} 
                                <span class="text-[10px] opacity-75">(${severity})</span>
                            </span>
                            <span class="text-[10px] text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-xs text-gray-400">${data.message}</p>
                    `;
                    aiTab.insertBefore(alertDiv, aiTab.firstChild);
                    
                    // Keep only last 20 alerts
                    const alerts = aiTab.querySelectorAll('div.p-3');
                    if (alerts.length > 20) {
                        alerts[alerts.length - 1].remove();
                    }
                }
            });
        }
        {% endif %}

        // Update button states
        const micBtn = document.getElementById('toggleMic');
        const camBtn = document.getElementById('toggleCam');

        if (micBtn) {
            micBtn.addEventListener('click', () => {
                const icon = micBtn.querySelector('i');
                // Toggle logic handled by webrtc.js, just updating UI here
                if (micBtn.classList.contains('bg-red-500')) {
                    micBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    micBtn.classList.add('bg-gray-800', 'hover:bg-gray-700');
                    icon.className = 'fa-solid fa-microphone';
                } else {
                    micBtn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
                    micBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    icon.className = 'fa-solid fa-microphone-slash';
                }
            });
        }

        if (camBtn) {
            camBtn.addEventListener('click', () => {
                const icon = camBtn.querySelector('i');
                if (camBtn.classList.contains('bg-red-500')) {
                    camBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    camBtn.classList.add('bg-gray-800', 'hover:bg-gray-700');
                    icon.className = 'fa-solid fa-video';
                } else {
                    camBtn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
                    camBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    icon.className = 'fa-solid fa-video-slash';
                }
            });
        }

        function confirmEndCall() {
            if (confirm("Are you sure you want to end the interview?")) {
                window.location.href = "{{ url_for('main.dashboard') }}";
            }
        }

        // Mark interview as completed
        function markAsCompleted() {
            if (!confirm("Are you sure you want to mark this interview as completed?")) {
                return;
            }

            const meetingLink = "{{ meeting_link }}";
            const completeBtn = document.getElementById('completeInterviewBtn');
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');

            // Disable button and show loading
            if (completeBtn) {
                completeBtn.disabled = true;
                completeBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...';
            }

            // Make API call
            fetch(`/interview/${meetingLink}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    if (statusBadge) {
                        statusBadge.className = 'px-2 py-0.5 rounded bg-green-500/10 border border-green-500/20 flex items-center gap-2';
                        statusBadge.innerHTML = `
                            <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                            <span class="text-[10px] font-bold text-green-400 uppercase tracking-wider">Completed</span>
                        `;
                    }
                    if (completeBtn) {
                        completeBtn.style.display = 'none';
                    }
                    if (typeof showToast === 'function') {
                        showToast('Interview marked as completed successfully!');
                    } else {
                        alert('Interview marked as completed successfully!');
                    }
                } else {
                    alert('Error: ' + (data.message || 'Failed to update status'));
                    if (completeBtn) {
                        completeBtn.disabled = false;
                        completeBtn.innerHTML = '<i class="fa-solid fa-check-circle"></i> Mark as Completed';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the status. Please try again.');
                if (completeBtn) {
                    completeBtn.disabled = false;
                    completeBtn.innerHTML = '<i class="fa-solid fa-check-circle"></i> Mark as Completed';
                }
            });
        }

        // Tab Switching Logic
        function switchTab(tabName) {
            const chatTab = document.getElementById('chatTab');
            const aiTab = document.getElementById('aiTab');
            // Simple toggle for now
            if (tabName === 'chat') {
                chatTab.classList.remove('hidden');
                aiTab.classList.add('hidden');
            } else {
                chatTab.classList.add('hidden');
                aiTab.classList.remove('hidden');
            }
        }

        // Join Request Logic (Preserved)
        const preJoinScreen = document.getElementById('preJoinScreen');
        const waitingScreen = document.getElementById('waitingScreen');
        const mainContainer = document.getElementById('mainContainer');
        const previewVideo = document.getElementById('previewVideo');
        const checkDevicesBtn = document.getElementById('checkDevicesBtn');
        const askToJoinBtn = document.getElementById('askToJoinBtn');
        const deviceStatus = document.getElementById('deviceStatus');
        const approvalPopup = document.getElementById('approvalPopup');
        const approveJoinBtn = document.getElementById('approveJoinBtn');
        const denyJoinBtn = document.getElementById('denyJoinBtn');

        // Wait for socket connection before setting up handlers
        socket.on('connect', () => {
            console.log('Socket connected');
            
            // Interviewer: Join main room immediately to receive join requests
            if (ROLE === 'interviewer') {
                socket.emit('join', { room: ROOM_ID, username: USERNAME });
                console.log('Interviewer joined room:', ROOM_ID);
            }
        });
        
        // Handle socket disconnection
        socket.on('disconnect', () => {
            console.log('Socket disconnected');
            if (typeof showToast === 'function') {
                showToast('Connection lost. Attempting to reconnect...');
            }
        });
        
        // Handle connection errors
        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
            if (typeof showToast === 'function') {
                showToast('Connection error. Please refresh the page.');
            }
        });

        // Candidate Flow
        if (ROLE === 'candidate' && JOIN_STATUS !== 'approved') {
            // Device Check
            if (checkDevicesBtn) {
                checkDevicesBtn.addEventListener('click', async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        previewVideo.srcObject = stream;
                        deviceStatus.textContent = "Camera and Microphone are working!";
                        deviceStatus.className = "mt-4 text-sm text-green-500";
                        askToJoinBtn.disabled = false;
                    } catch (err) {
                        console.error(err);
                        deviceStatus.textContent = "Error accessing devices: " + err.message;
                        deviceStatus.className = "mt-4 text-sm text-red-500";
                    }
                });
            }

            // Ask to Join
            if (askToJoinBtn) {
                askToJoinBtn.addEventListener('click', () => {
                    // Ensure socket is connected
                    if (socket.connected) {
                        socket.emit('request-join', { room: ROOM_ID, username: USERNAME });
                        preJoinScreen.style.display = 'none';
                        waitingScreen.style.display = 'flex';

                        // Stop preview stream
                        if (previewVideo.srcObject) {
                            previewVideo.srcObject.getTracks().forEach(track => track.stop());
                        }
                    } else {
                        console.error('Socket not connected');
                        alert('Connection error. Please refresh the page.');
                    }
                });
            }

            // Listen for approval
            socket.on('join-approved', (data) => {
                console.log('Join approved, moving to main room');
                waitingScreen.style.display = 'none';
                mainContainer.style.display = 'flex';
                
                // Show success message
                if (typeof showToast === 'function') {
                    showToast('You have been approved! Joining the interview...');
                }
                
                // Leave waiting room and join main room
                socket.emit('leave', { room: `${ROOM_ID}_waiting`, username: USERNAME });
                
                // Small delay to ensure room transition
                setTimeout(() => {
                    socket.emit('join', { room: ROOM_ID, username: USERNAME });
                    
                    // Start WebRTC meeting
                    if (typeof initializeMeeting === 'function') {
                        initializeMeeting();
                    }
                }, 100);
            });

            socket.on('join-rejected', (data) => {
                const message = data?.message || "Your request to join was denied.";
                alert(message);
                window.location.href = "{{ url_for('main.dashboard') }}";
            });
        } else {
            // Interviewer or Approved Candidate - join immediately
            socket.on('connect', () => {
                if (typeof initializeMeeting === 'function') {
                    initializeMeeting();
                }
            });
            
            // Also try immediately in case socket is already connected
            if (socket.connected && typeof initializeMeeting === 'function') {
                initializeMeeting();
            }
        }

        // Interviewer Flow - Setup approval handlers
        if (ROLE === 'interviewer') {
            socket.on('join-request', (data) => {
                console.log('Join request received:', data);
                const userSpan = document.getElementById('requestingUser');
                if (userSpan) userSpan.textContent = data.username || 'Candidate';
                if (approvalPopup) {
                    approvalPopup.style.display = 'block';
                    // Show notification
                    if (typeof showToast === 'function') {
                        showToast(`${data.username || 'Candidate'} wants to join the interview`);
                    }
                    // Auto-hide after 30 seconds if not responded
                    setTimeout(() => {
                        if (approvalPopup.style.display === 'block') {
                            approvalPopup.style.display = 'none';
                        }
                    }, 30000);
                }
            });

            if (approveJoinBtn) {
                approveJoinBtn.addEventListener('click', () => {
                    console.log('Approving join request');
                    socket.emit('approve-join', { room: ROOM_ID });
                    if (approvalPopup) approvalPopup.style.display = 'none';
                    if (typeof showToast === 'function') {
                        showToast('Candidate approved and joining...');
                    }
                });
            }

            if (denyJoinBtn) {
                denyJoinBtn.addEventListener('click', () => {
                    console.log('Rejecting join request');
                    socket.emit('reject-join', { room: ROOM_ID });
                    if (approvalPopup) approvalPopup.style.display = 'none';
                    if (typeof showToast === 'function') {
                        showToast('Join request rejected');
                    }
                });
            }
            
            // Listen for candidate approval confirmation
            socket.on('candidate-approved', (data) => {
                console.log('Candidate approved:', data);
                if (typeof showToast === 'function') {
                    showToast('Candidate has joined the interview');
                }
            });
        }
    </script>
</body>

</html>